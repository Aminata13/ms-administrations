db.comptes.aggregate([
  { $addFields: {
    userObjectId: { $toObjectId: "$infosPersoId" }
  }},
  { $lookup: {
    from: "infosPersos",
    localField: "userObjectId",
    foreignField: "_id",
    as: "infosPerso"
  }},
  {
    $unwind: "$infosPerso"
  },
  { $match: {
    $and: [{ deleted: false }, { type: "COMPTE_PARTICULIER" }, { "infosPerso.prenom": "Aminata" }]
  }}
])

db.comptes.aggregate([
  { $addFields: {
    userObjectId: { $toObjectId: "$infosPersoId" }
  }},
  { $lookup: {
    from: "infosPersos",
    localField: "userObjectId",
    foreignField: "_id",
    as: "infosPerso"
  }},
  {
    $unwind: "$infosPerso"
  },
  { $match: {
    $and: [{ deleted: false }, { type: "COMPTE_PARTICULIER" }, { "infosPerso.prenom": "Aminata" }]
  }}
])

listAggregations.add(l -> new Document("$lookup",
  new Document("from", mongoTemplate.getCollectionName(Compte.class))
  .append("let", new Document("userObjectId", new Document("$toObjectId", "$infosPersoId")))
  .append("pipeline", Arrays.asList(new Document("$match",
    new Document("$expr", new Document("$eq", Arrays.asList("$id", "$$userObjectId"))))))
  .append("as", "userInfos")));



  db.collection.aggregate( [ { aggregation steps... }, { $out : "results" } ] )

db.abonnements.aggregate([
  { $addFields: {
    userObjectId: { $toObjectId: "$compteClient.infosPersoId" }
  }},
  { $lookup: {
    from: "infosPersos",
    localField: "userObjectId",
    foreignField: "_id",
    as: "infosPerso"
  }},
  {
    $unwind: "$infosPerso"
  },
  { $match: {
    deleted: false
  }},
  {
    $out : "listAbonnees"
  }
])

mongoexport --db=slAdministrations --collection=listAbonnees --fields=dateCreation,infosPerso.prenom,infosPerso.nom,infosPerso.email,infosPerso.telephone,typeAbonnement.libelle,numeroCarte,solde --type=csv --out=data/listAbonnees.csv

//*********** MOSQUITTO ************//

listener 1883 localhost

listener 8883
certfile /etc/letsencrypt/live/mqtt.safelogistics-senegal.com/cert.pem
cafile /etc/letsencrypt/live/mqtt.safelogistics-senegal.com/chain.pem
keyfile /etc/letsencrypt/live/mqtt.safelogistics-senegal.com/privkey.pem

listener 8083
protocol websockets
certfile /etc/letsencrypt/live/mqtt.safelogistics-senegal.com/cert.pem
cafile /etc/letsencrypt/live/mqtt.safelogistics-senegal.com/chain.pem
keyfile /etc/letsencrypt/live/mqtt.safelogistics-senegal.com/privkey.pem

listener 1883

listener 8083
protocol websockets
